{{ $currentPost := . }}
{{ $relatedPosts := slice }}

{{/* First try to find posts with matching tags */}}
{{ if .Params.tags }}
  {{ range .Site.RegularPages }}
    {{ if and (eq .Section "blog") (ne .Permalink $currentPost.Permalink) }}
      {{ $commonTags := intersect .Params.tags $currentPost.Params.tags }}
      {{ if gt (len $commonTags) 0 }}
        {{ $relatedPosts = $relatedPosts | append . }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* If we don't have enough related posts, add recent posts */}}
{{ if lt (len $relatedPosts) 3 }}
  {{ range (where .Site.RegularPages "Section" "blog") }}
    {{ if and (ne .Permalink $currentPost.Permalink) (not (in $relatedPosts .)) }}
      {{ $relatedPosts = $relatedPosts | append . }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Limit to 3 posts */}}
{{ $relatedPosts = first 3 $relatedPosts }}

{{ if gt (len $relatedPosts) 0 }}
<div class="recommended-posts" style="margin-top: 40px;">
  <h3 style="margin-bottom: 20px; font-size: 1.4em; font-weight: bold; color: #000;">Recommended Posts</h3>
  <div style="display: flex; flex-direction: column; gap: 16px;">
    {{ range $relatedPosts }}
    {{ $firstSentence := "" }}
    {{ if .Description }}
      {{ $firstSentence = .Description }}
    {{ else if .Summary }}
      {{ $firstSentence = .Summary }}
    {{ else }}
      {{ $content := .Plain }}
      {{ $sentence := findRE `[^.!?]*[.!?]` $content 1 }}
      {{ if $sentence }}
        {{ $firstSentence = index $sentence 0 }}
      {{ else }}
        {{ $firstSentence = truncate 150 $content }}
      {{ end }}
    {{ end }}

    <div style="
        background: #fff1e6;
        border: 3px solid #000;
        padding: 20px;
        transition: background-color 0.2s ease;
        cursor: pointer;
        display: flex;
        align-items: flex-start;
        gap: 20px;
    " onmouseover="this.style.backgroundColor='#ffede0'" onmouseout="this.style.backgroundColor='#fff1e6'" onclick="window.location.href='{{ .Permalink }}'">
      <div style="
          flex-shrink: 0;
          font-size: 0.85em;
          color: #666;
          font-weight: 500;
          min-width: 100px;
      ">
        {{ .Date.Format "02 Jan, 2006" }}
      </div>
      <div style="flex: 1;">
        <h4 style="margin: 0 0 10px 0; font-size: 1.2em; font-weight: bold;">
          <span style="color: #000;">{{ .Title }}</span>
        </h4>
        <p style="margin: 0; color: #333; line-height: 1.5; font-size: 0.95em;">
          {{ $firstSentence | plainify | truncate 200 }}
        </p>
        {{ if .Params.tags }}
          {{ $tags := delimit .Params.tags " #" }}
          <div style="margin-top: 8px; font-size: 0.85em; color: #666; font-weight: 500;">
            <span>#{{ $tags }}</span>
          </div>
        {{ end }}
      </div>
    </div>
    {{ end }}
  </div>
</div>
{{ end }}